name: MY Web and API PROD

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-test-publish:
    name: Build, test, and publish artifacts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Restore dependencies
        run: dotnet restore "Transaction Sql Crud Operation.slnx"

      - name: Build solution
        run: dotnet build "Transaction Sql Crud Operation.slnx" --configuration Release --no-restore

      - name: Run tests
        run: dotnet test "Transaction Sql Crud Operation.slnx" --configuration Release --no-build --verbosity normal

      - name: Publish Qualification web app
        run: dotnet publish "Qualification/Qualification.csproj" --configuration Release --output ./artifacts/qualification

      - name: Publish Transaction Sql Crud Operation API
        run: dotnet publish "Transaction Sql Crud Operation/Transaction Sql Crud Operation.csproj" --configuration Release --output ./artifacts/transaction-api

      - name: Upload Qualification artifact
        uses: actions/upload-artifact@v4
        with:
          name: qualification-web
          path: ./artifacts/qualification

      - name: Upload API artifact
        uses: actions/upload-artifact@v4
        with:
          name: transaction-api
          path: ./artifacts/transaction-api

  deploy:
    name: Deploy web.dev.com and api.dev.com
    runs-on: ubuntu-latest
    needs: build-test-publish
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
      - name: Download Qualification artifact
        uses: actions/download-artifact@v4
        with:
          name: qualification-web
          path: ./deploy/qualification

      - name: Download API artifact
        uses: actions/download-artifact@v4
        with:
          name: transaction-api
          path: ./deploy/transaction-api

      - name: Copy artifacts to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          source: "deploy/qualification/*,deploy/transaction-api/*"
          target: "/tmp/github-deploy"
          strip_components: 1

      - name: Deploy and restart services
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            set -e
            sudo mkdir -p /var/www/web.dev.com /var/www/api.dev.com
            sudo rsync -av --delete /tmp/github-deploy/qualification/ /var/www/web.dev.com/
            sudo rsync -av --delete /tmp/github-deploy/transaction-api/ /var/www/api.dev.com/
            sudo systemctl restart qualification-web.service
            sudo systemctl restart transaction-api.service
            sudo systemctl reload nginx
